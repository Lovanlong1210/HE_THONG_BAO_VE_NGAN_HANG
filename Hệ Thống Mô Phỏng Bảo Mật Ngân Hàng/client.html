<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng B·∫£o m·∫≠t Ng√¢n h√†ng</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .game-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .panel-header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .panel-content {
            padding: 30px;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4f46e5;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4);
        }

        .btn-full {
            width: 100%;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4f46e5;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6b7280;
            font-weight: 500;
        }

        .transaction-list {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .transaction-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            transition: border-color 0.3s, transform 0.2s;
        }

        .transaction-card.active {
            border-color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        .transaction-card.completed {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .transaction-id {
            font-weight: bold;
            color: #4f46e5;
        }

        .transaction-amount {
            font-size: 1.2em;
            font-weight: bold;
            color: #059669;
        }

        .transaction-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #4f46e5;
        }

        .detail-label {
            font-size: 0.9em;
            color: #6b7280;
            margin-bottom: 2px;
        }

        .detail-value {
            font-weight: 500;
        }

        .security-steps {
            margin-top: 20px;
        }

        .step {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            color: white;
        }

        .step-aes .step-icon { background: #ef4444; }
        .step-rsa .step-icon { background: #f59e0b; }
        .step-sha .step-icon { background: #10b981; }

        .step-content textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
border: 1px solid #d1d5db;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }

        .step-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: 500;
        }

        .step-result.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .step-result.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .crypto-help {
            background: #fffbeb;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .help-section {
            margin-bottom: 15px;
        }

        .help-title {
            font-weight: bold;
            color: #92400e;
            margin-bottom: 5px;
        }

        .help-desc {
            color: #78350f;
            font-size: 0.9em;
        }

        .feedback-area {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .feedback-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .feedback-item:last-child {
            border-bottom: none;
        }

        .feedback-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .leaderboard {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        .leaderboard-header {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank {
            font-weight: bold;
            color: #4f46e5;
            width: 40px;
        }

        .player-info {
            flex: 1;
            margin-left: 15px;
        }

        .player-name {
            font-weight: 600;
        }

        .player-stats {
            font-size: 0.9em;
            color: #6b7280;
        }

        .player-score {
            font-weight: bold;
            color: #059669;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .level-badge {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .progress-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            background: linear-gradient(135deg, #10b981, #059669);
            height: 100%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stats-bar {
                grid-template-columns: 1fr;
            }
            
            .transaction-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ H·ªá th·ªëng B·∫£o m·∫≠t Ng√¢n h√†ng</h1>
            <p>Tr√≤ ch∆°i m√¥ ph·ªèng b·∫£o m·∫≠t giao d·ªãch v·ªõi AES, RSA v√† SHA</p>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="game-panel">
            <div class="panel-header">
                <h2>üîê ƒêƒÉng nh·∫≠p v√†o H·ªá th·ªëng</h2>
                <p>Nh·∫≠p t√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu l√†m vi·ªác nh∆∞ m·ªôt Chuy√™n vi√™n B·∫£o m·∫≠t Ng√¢n h√†ng</p>
            </div>
            <div class="panel-content">
                <div class="login-form">
                    <div class="form-group">
                        <label for="playerName">T√™n Chuy√™n vi√™n B·∫£o m·∫≠t:</label>
                        <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." required>
                    </div>
                    <button class="btn btn-full" onclick="startGame()">
                        üöÄ B·∫Øt ƒë·∫ßu Nhi·ªám v·ª•
                    </button>
                </div>
                
                <div class="crypto-help">
                    <h3>üìö H∆∞·ªõng d·∫´n Thu·∫≠t to√°n</h3>
                    <div class="help-section">
                        <div class="help-title">üî¥ AES (Advanced Encryption Standard)</div>
                        <div class="help-desc">M√£ h√≥a ƒë·ªëi x·ª©ng 256-bit b·∫£o v·ªá d·ªØ li·ªáu giao d·ªãch kh·ªèi b·ªã ƒë·ªçc tr·ªôm</div>
                    </div>
                    <div class="help-section">
                        <div class="help-title">üü° RSA (Rivest-Shamir-Adleman)</div>
<div class="help-desc">Ch·ªØ k√Ω s·ªë 2048-bit ƒë·∫£m b·∫£o x√°c th·ª±c ng∆∞·ªùi g·ª≠i v√† kh√¥ng th·ªÉ ch·ªëi b·ªè</div>
                    </div>
                    <div class="help-section">
                        <div class="help-title">üü¢ SHA-256 (Secure Hash Algorithm)</div>
                        <div class="help-desc">H√†m bƒÉm m·∫≠t m√£ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn, ph√°t hi·ªán m·ªçi thay ƒë·ªïi d·ªØ li·ªáu</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden">
            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stat-value" id="playerLevel">1</div>
                    <div class="stat-label">Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="playerScore">0</div>
                    <div class="stat-label">ƒêi·ªÉm s·ªë</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="processedCount">0</div>
                    <div class="stat-label">Giao d·ªãch ƒë√£ x·ª≠ l√Ω</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="timeRemaining">--:--</div>
                    <div class="stat-label">Th·ªùi gian c√≤n l·∫°i</div>
                </div>
            </div>

            <!-- Current Level Info -->
            <div class="game-panel">
                <div class="panel-header">
                    <h2 id="levelTitle">Level 1 - Giao d·ªãch C∆° b·∫£n</h2>
                    <div class="level-badge" id="levelBadge">Trainee Security Officer</div>
                </div>
                <div class="panel-content">
                    <div id="levelDescription">
                        X·ª≠ l√Ω c√°c giao d·ªãch ƒë∆°n gi·∫£n v·ªõi c√°c b∆∞·ªõc b·∫£o m·∫≠t c∆° b·∫£n. Ho√†n th√†nh t·∫•t c·∫£ giao d·ªãch ƒë·ªÉ l√™n level!
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="levelProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Transaction List -->
            <div id="transactionList" class="transaction-list">
                <!-- Transactions will be loaded here -->
            </div>

            <!-- Security Processing Panel -->
            <div id="securityPanel" class="game-panel hidden">
                <div class="panel-header">
                    <h2>üîí B·∫£o m·∫≠t Giao d·ªãch</h2>
                    <p>Th·ª±c hi·ªán c√°c b∆∞·ªõc b·∫£o m·∫≠t cho giao d·ªãch <span id="currentTransactionId"></span></p>
                </div>
                <div class="panel-content">
                    <div class="security-steps">
                        <!-- AES Step -->
                        <div class="step step-aes">
<div class="step-header">
                                <div class="step-icon">1</div>
                                <div>
                                    <strong>M√£ h√≥a AES</strong>
                                    <div style="font-size: 0.9em; color: #6b7280;">B·∫£o v·ªá d·ªØ li·ªáu giao d·ªãch</div>
                                </div>
                            </div>
                            <div class="step-content">
                                <button class="btn" onclick="performAESEncryption()">üî¥ Th·ª±c hi·ªán M√£ h√≥a AES</button>
                                <textarea id="aesResult" placeholder="K·∫øt qu·∫£ m√£ h√≥a AES s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..." readonly></textarea>
                                <div id="aesStatus" class="step-result hidden"></div>
                            </div>
                        </div>

                        <!-- RSA Step -->
                        <div class="step step-rsa">
                            <div class="step-header">
                                <div class="step-icon">2</div>
                                <div>
                                    <strong>Ch·ªØ k√Ω RSA</strong>
                                    <div style="font-size: 0.9em; color: #6b7280;">X√°c th·ª±c ng∆∞·ªùi g·ª≠i</div>
                                </div>
                            </div>
                            <div class="step-content">
                                <button class="btn" onclick="performRSASignature()">üü° T·∫°o Ch·ªØ k√Ω RSA</button>
                                <textarea id="rsaResult" placeholder="Ch·ªØ k√Ω RSA s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..." readonly></textarea>
                                <div id="rsaStatus" class="step-result hidden"></div>
                            </div>
                        </div>

                        <!-- SHA Step -->
                        <div class="step step-sha">
                            <div class="step-header">
                                <div class="step-icon">3</div>
                                <div>
                                    <strong>Hash SHA-256</strong>
                                    <div style="font-size: 0.9em; color: #6b7280;">ƒê·∫£m b·∫£o t√≠nh to√†n v·∫πn</div>
                                </div>
                            </div>
                            <div class="step-content">
                                <button class="btn" onclick="performSHAHash()">üü¢ T·∫°o Hash SHA-256</button>
                                <textarea id="shaResult" placeholder="Hash SHA-256 s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..." readonly></textarea>
                                <div id="shaStatus" class="step-result hidden"></div>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn" onclick="submitSecurity()" style="font-size: 1.1em; padding: 15px 30px;">
‚úÖ X√°c nh·∫≠n B·∫£o m·∫≠t Giao d·ªãch
                        </button>
                        <button class="btn" onclick="cancelSecurity()" style="background: #6b7280; margin-left: 15px;">
                            ‚ùå H·ªßy b·ªè
                        </button>
                    </div>

                    <!-- Feedback Area -->
                    <div id="feedbackArea" class="feedback-area hidden">
                        <h3>üìä K·∫øt qu·∫£ ƒê√°nh gi√°</h3>
                        <div id="feedbackList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div id="leaderboard" class="leaderboard hidden">
            <div class="leaderboard-header">
                üèÜ B·∫£ng X·∫øp h·∫°ng Chuy√™n vi√™n B·∫£o m·∫≠t
            </div>
            <div id="leaderboardList">
                <!-- Leaderboard items will be loaded here -->
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="loading hidden">
            <div class="spinner"></div>
            <div>ƒêang x·ª≠ l√Ω...</div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let sessionId = null;
        let activeTransactionId = null;
        let completedTransactions = new Set();
        let currentTransactionSecurityData = {}; // Bi·∫øn ƒë·ªÉ l∆∞u tr·ªØ key, iv, tag

        // API Configuration
        const API_BASE = 'http://localhost:5000/api';
        
        // Game State
        let gameState = {
            sessionId: null,
            currentTransaction: null,
            transactions: [],
            securityResult: null,
            timer: null,
            timeLimit: 0
        };

        // Utility Functions
        function showLoading() {
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // API Functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'API Error');
                }
return result;
            } catch (error) {
                console.error('API Error:', error);
                alert('L·ªói k·∫øt n·ªëi ƒë·∫øn server: ' + error.message);
                throw error;
            }
        }

        // Game Functions
        async function startGame() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
                return;
            }

            showLoading();
            try {
                const result = await apiCall('/start_game', 'POST', { player_name: playerName });
                gameState.sessionId = result.session_id;
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                
                updateGameStats(result.session_info);
                await loadTransactions();
                loadLeaderboard();
                
                hideLoading();
                alert(`Ch√†o m·ª´ng ${playerName}! Nhi·ªám v·ª• b·∫£o m·∫≠t ƒë√£ b·∫Øt ƒë·∫ßu!`);
            } catch (error) {
                hideLoading();
            }
        }

        async function loadTransactions() {
            try {
                const result = await apiCall(`/get_transactions/${gameState.sessionId}`);
                gameState.transactions = result.transactions;
                gameState.timeLimit = result.level_config.time_limit;
                
                updateLevelInfo(result.level, result.level_config);
                renderTransactions();
                startTimer();
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        function updateGameStats(sessionInfo) {
            document.getElementById('playerLevel').textContent = sessionInfo.level;
            document.getElementById('playerScore').textContent = sessionInfo.score;
            document.getElementById('processedCount').textContent = sessionInfo.transactions_processed;
            
            const badges = {
                1: 'Trainee Security Officer',
                2: 'Junior Security Analyst', 
                3: 'Senior Security Expert'
            };
            document.getElementById('levelBadge').textContent = badges[sessionInfo.level] || 'Security Professional';
        }

        function updateLevelInfo(level, config) {
            const titles = {
                1: 'Level 1 - Giao d·ªãch C∆° b·∫£n',
                2: 'Level 2 - Giao d·ªãch N√¢ng cao',
                3: 'Level 3 - Giao d·ªãch Chuy√™n nghi·ªáp'
            };
            
            const descriptions = {
                1: 'X·ª≠ l√Ω c√°c giao d·ªãch ƒë∆°n gi·∫£n v·ªõi c√°c b∆∞·ªõc b·∫£o m·∫≠t c∆° b·∫£n. Ho√†n th√†nh t·∫•t c·∫£ giao d·ªãch ƒë·ªÉ l√™n level!',
2: 'X·ª≠ l√Ω nhi·ªÅu giao d·ªãch h∆°n v·ªõi y√™u c·∫ßu b·∫£o m·∫≠t cao h∆°n. T·ªëc ƒë·ªô x·ª≠ l√Ω s·∫Ω ·∫£nh h∆∞·ªüng ƒë·∫øn ƒëi·ªÉm s·ªë!',
                3: 'Th·ª≠ th√°ch cu·ªëi c√πng! X·ª≠ l√Ω c√°c giao d·ªãch ph·ª©c t·∫°p v·ªõi m·ª©c b·∫£o m·∫≠t t·ªëi ƒëa trong th·ªùi gian ng·∫Øn!'
            };
            
            document.getElementById('levelTitle').textContent = titles[level];
            document.getElementById('levelDescription').textContent = descriptions[level];
        }

        function renderTransactions() {
            const container = document.getElementById('transactionList');
            container.innerHTML = '';
            
            gameState.transactions.forEach((transaction, index) => {
                const card = document.createElement('div');
                card.className = 'transaction-card';
                card.innerHTML = `
                    <div class="transaction-header">
                        <div class="transaction-id">${transaction.id}</div>
                        <div class="transaction-amount">${formatCurrency(transaction.amount)}</div>
                    </div>
                    <div class="transaction-details">
                        <div class="detail-item">
                            <div class="detail-label">T·ª´ t√†i kho·∫£n</div>
                            <div class="detail-value">${transaction.from_account}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ƒê·∫øn t√†i kho·∫£n</div>
                            <div class="detail-value">${transaction.to_account}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Th·ªùi gian</div>
                            <div class="detail-value">${new Date(transaction.timestamp).toLocaleString('vi-VN')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">N·ªôi dung</div>
                            <div class="detail-value">${transaction.message}</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn" onclick="startSecurityProcess('${transaction.id}')">
                            üîí B·∫Øt ƒë·∫ßu B·∫£o m·∫≠t
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function startTimer() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            let timeLeft = gameState.timeLimit;
            gameState.timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timeRemaining').textContent = formatTime(timeLeft);
                
                if (timeLeft <= 0) {
clearInterval(gameState.timer);
                    alert('H·∫øt th·ªùi gian! Game k·∫øt th√∫c.');
                    // Handle game over
                }
            }, 1000);
        }

        async function startSecurityProcess(transactionId) {
            gameState.currentTransaction = gameState.transactions.find(t => t.id === transactionId);
            if (!gameState.currentTransaction) return;
            
            document.getElementById('currentTransactionId').textContent = transactionId;
            document.getElementById('securityPanel').classList.remove('hidden');
            
            // Reset previous results
            ['aesResult', 'rsaResult', 'shaResult'].forEach(id => {
                document.getElementById(id).value = '';
            });
            ['aesStatus', 'rsaStatus', 'shaStatus'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById('feedbackArea').classList.add('hidden');
            
            // Scroll to security panel
            document.getElementById('securityPanel').scrollIntoView({ behavior: 'smooth' });
        }

        async function performAESEncryption() {
            if (!gameState.currentTransaction) return;
            
            showLoading();
            try {
                const result = await apiCall('/process_transaction', 'POST', {
                    transaction_id: gameState.currentTransaction.id
                });
                
                gameState.securityResult = result;
                document.getElementById('aesResult').value = result.aes_encrypted;
                document.getElementById('aesStatus').innerHTML = '‚úÖ M√£ h√≥a AES th√†nh c√¥ng!';
                document.getElementById('aesStatus').className = 'step-result success';
                document.getElementById('aesStatus').classList.remove('hidden');
                
                // L∆∞u tr·ªØ to√†n b·ªô d·ªØ li·ªáu b·∫£o m·∫≠t
                currentTransactionSecurityData = {
                    aes_key: result.aes_key,
                    aes_iv: result.aes_iv,
                    aes_tag: result.aes_tag
                };
                
                hideLoading();
            } catch (error) {
                hideLoading();
                document.getElementById('aesStatus').innerHTML = '‚ùå L·ªói m√£ h√≥a AES!';
                document.getElementById('aesStatus').className = 'step-result error';
                document.getElementById('aesStatus').classList.remove('hidden');
            }
        }

        async function performRSASignature() {
            if (!gameState.securityResult) {
                alert('Vui l√≤ng th·ª±c hi·ªán m√£ h√≥a AES tr∆∞·ªõc!');
                return;
            }
            
            document.getElementById('rsaResult').value = gameState.securityResult.rsa_signature;
            document.getElementById('rsaStatus').innerHTML = '‚úÖ T·∫°o ch·ªØ k√Ω RSA th√†nh c√¥ng!';
            document.getElementById('rsaStatus').className = 'step-result success';
            document.getElementById('rsaStatus').classList.remove('hidden');
        }

        async function performSHAHash() {
            if (!gameState.securityResult) {
alert('Vui l√≤ng th·ª±c hi·ªán c√°c b∆∞·ªõc tr∆∞·ªõc ƒë√≥!');
                return;
            }
            
            document.getElementById('shaResult').value = gameState.securityResult.sha256_hash;
            document.getElementById('shaStatus').innerHTML = '‚úÖ T·∫°o hash SHA-256 th√†nh c√¥ng!';
            document.getElementById('shaStatus').className = 'step-result success';
            document.getElementById('shaStatus').classList.remove('hidden');
        }

        async function submitSecurity() {
            if (!gameState.securityResult) {
                alert('Vui l√≤ng ho√†n th√†nh t·∫•t c·∫£ c√°c b∆∞·ªõc b·∫£o m·∫≠t tr∆∞·ªõc!');
                return;
            }
            
            const answers = {
                aes_encrypted: document.getElementById('aesResult').value,
                rsa_signature: document.getElementById('rsaResult').value,
                sha256_hash: document.getElementById('shaResult').value,
                // Th√™m key, iv, v√† tag v√†o payload
                ...currentTransactionSecurityData 
            };
            
            showLoading();
            try {
                const result = await apiCall('/verify_security', 'POST', {
                    session_id: gameState.sessionId,
                    transaction_id: gameState.currentTransaction.id,
                    answers: answers
                });
                
                // Update game stats
                updateGameStats(result.session_info);
                
                // Show feedback
                showFeedback(result);
                
                // Mark transaction as completed
                const transactionCards = document.querySelectorAll('.transaction-card');
                transactionCards.forEach(card => {
                    if (card.innerHTML.includes(gameState.currentTransaction.id)) {
                        card.classList.add('completed');
                    }
                });
                
                // Update progress
                const processed = result.session_info.transactions_processed;
                const total = gameState.transactions.length;
                const progress = (processed / total) * 100;
                document.getElementById('levelProgress').style.width = progress + '%';
                
                hideLoading();
                
                // Check if level completed
                if (processed >= total) {
                    setTimeout(() => {
                        alert('üéâ Ho√†n th√†nh level! ƒêang t·∫£i level ti·∫øp theo...');
                        loadTransactions();
                    }, 2000);
                }
                
                // Update leaderboard
                updateLeaderboard();
                
            } catch (error) {
                hideLoading();
            }
        }

        function showFeedback(result) {
            const feedbackArea = document.getElementById('feedbackArea');
            const feedbackList = document.getElementById('feedbackList');
            
            feedbackList.innerHTML = '';
            result.feedback.forEach(feedback => {
const item = document.createElement('div');
                item.className = 'feedback-item';
                item.innerHTML = `
                    <div class="feedback-icon">${feedback.includes('‚úÖ') ? '‚úÖ' : feedback.includes('‚ùå') ? '‚ùå' : 'üéâ'}</div>
                    <div>${feedback}</div>
                `;
                feedbackList.appendChild(item);
            });
            
            // Add score info
            const scoreItem = document.createElement('div');
            scoreItem.className = 'feedback-item';
            scoreItem.innerHTML = `
                <div class="feedback-icon">üíØ</div>
                <div>ƒêi·ªÉm nh·∫≠n ƒë∆∞·ª£c: <strong>${result.total_score}</strong></div>
            `;
            feedbackList.appendChild(scoreItem);
            
            feedbackArea.classList.remove('hidden');
        }

        function cancelSecurity() {
            document.getElementById('securityPanel').classList.add('hidden');
            gameState.currentTransaction = null;
            gameState.securityResult = null;
        }

        async function loadLeaderboard() {
            try {
                const result = await apiCall('/leaderboard');
                const container = document.getElementById('leaderboardList');
                container.innerHTML = '';
                
                result.forEach(player => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `
                        <div class="rank">#${player.rank}</div>
                        <div class="player-info">
                            <div class="player-name">${player.player_name}</div>
                            <div class="player-stats">Level ${player.level} ‚Ä¢ ${player.transactions_processed} giao d·ªãch</div>
                        </div>
                        <div class="player-score">${player.score} ƒëi·ªÉm</div>
                    `;
                    container.appendChild(item);
                });
                
                document.getElementById('leaderboard').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('üè¶ Banking Security Game Client Loaded');
        });

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
        });
    </script>
</body>
</html>